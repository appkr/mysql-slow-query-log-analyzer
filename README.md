# mysql-slow-query-log-analyzer

## Feature

- MySQL slow query log content parsing
- EXPLAIN result for each query
- Filtering and Sorting (e.g. filter slower than 200ms and sort slowest first: `filterMillis=200&sort=queryTime:desc`)

```shell
# An example from tools-string-boot-demo
# The Example was generated by https://github.com/appkr/msa-starter
curl -XPOST http://localhost:8080/demo/analyze-mysql-slow-query-log-job \
-F 'logFile=@"/path/to/slow.log"' \
-F 'filterMillis="200"' \
-F 'filterQuery="SELECT"' \
-F 'sort="queryTime:desc"'

{
  "summary": {
    "count": 3,
    "min": "PT0.225S",
    "average": "PT0.279S",
    "max": "PT0.384S"
  },
  "data": [
    {
      "time": "2023-04-25T09:43:53.224572+09:00",
      "user": "root",
      "host": "[172.19.0.1]",
      "id": "20",
      "queryTime": "PT0.384S",
      "lockTime": "PT0.002S",
      "rowsSent": 0,
      "rowsExamined": 494,
      "sql": "SELECT a1.id FROM regions AS r1, addresses AS a1 WHERE r1.rtype <> 0 AND r1.d1 = '강원도' AND r1.d2 = '철원군' AND r1.d3 = '갈말읍' AND r1.d4 = '상사리' AND (r1.rcode = a1.legal_dong_code OR r1.rcode = a1.admin_dong_code OR r1.rcode = a1.road_code) AND (a1.jibun_number LIKE '532-2%' OR a1.building_number LIKE '532-2%') AND a1.expose = 0 ORDER BY r1.d1, r1.d2 limit 50;",
      "executionPlans": [
        {
          "id": "1",
          "selectType": "SIMPLE",
          "table": "r1",
          "partitions": "",
          "type": "ref",
          "possibleKeys": "IDX_REGION,IDX_RCODE_RTYPE",
          "key": "IDX_REGION",
          "keyLen": "651",
          "ref": "const,const,const,const",
          "rows": "1",
          "filtered": "90.0",
          "extra": "Using where"
        },
        {
          "id": "1",
          "selectType": "SIMPLE",
          "table": "a1",
          "partitions": "",
          "type": "ALL",
          "possibleKeys": "IDX_LEGAL_DONG_CODE,IDX_ADMIN_DONG_CODE,IDX_ROAD_CODE",
          "key": "",
          "keyLen": "",
          "ref": "",
          "rows": "12088875",
          "filtered": "0.57",
          "extra": "Range checked for each record (index map: 0xE)"
        }
      ]
    },
    {...},
    {...}
  ]
}
```

## Install

Add library as a project dependency.

```groovy
// build.gradle
implementation 'dev.appkr:tools-spring-boot-starter:0.0.1-RELEASE'
```

Integrate the feature to your service.

```java
public class YourService {
  final dev.appkr.tools.core.FilterableLogAnalyzer analyzer;
  
  void yourMethod() {
    java.nio.file.Path path = Paths.of("/path/to/your/slow.log");
    Integer filterMillis = 200;
    String filterQuery = "SELECT";
    org.springframework.data.domain.Sort sortSpec = Sort.by(Sort.Direction.DESC, "queryTime");
    
    dev.appkr.tools.core.model.AnalysisReport report = analyzer.analyze(path, filterMillis, filterQuery, sortSpec);
  }
}
```

---

For developers

## Environment setup

Install (amazonaws corretto) jdk 17
```shell
$ brew install homebrew/cask-versions/corretto17 --cask
$ jenv add /Library/Java/JavaVirtualMachines/amazon-corretto-17.jdk/Contents/Home
$ jenv versions
```

Run MySQL(3306, root / secret) using following command
```shell
~/mysql-slow-query-log-analyzer $ ./gradlew composeUp
# To stop and delete the cluster, ./gradlew composeDown
```

## Contribution

Issue and PRs are always welcomed.
